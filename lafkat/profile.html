<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lafkat – Profil</title>
<meta name="theme-color" content="#FF7F2F" />
<style>
  :root{--orange:#FF7F2F;--orange-2:#ff9a58;--line:#ffd7bf;--ink:#1b1b1b}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,var(--orange) 0%,var(--orange-2) 100%);color:var(--ink)}
  .header{background:#fff4ec;border-bottom:1px solid var(--line)}
  .header .inner{max-width:1000px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:10px}
  nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  nav a{text-decoration:none;color:#7a3b14;font-weight:700;font-size:14px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
  nav a:hover{background:#ffefe4;border-color:#ffb98d}
  .wrap{max-width:1000px;margin:16px auto;padding:16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media (max-width:960px){.wrap{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
  .head{display:flex;align-items:center;gap:12px}
  .avatar{width:60px;height:60px;border-radius:50%;display:grid;place-items:center;
    background:radial-gradient(100% 100% at 30% 30%,#ffd18f,#ff7f2f);color:#fff;font-weight:900;font-size:22px}
  .muted{color:#7a3b14}
  .pill{display:inline-block;background:#ffe8d7;border:1px solid var(--line);padding:5px 10px;border-radius:999px;font-size:12px}
  .btn{cursor:pointer;border:none;background:#FF7F2F;color:#fff;padding:10px 14px;border-radius:10px;font-weight:800}
  .btn.secondary{background:#fff;color:#ff6a08;border:1.5px solid #ffd0b3}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .list{display:grid;gap:10px}
  .item{background:#fffdfb;border:1px solid var(--line);border-radius:12px;padding:10px}
  .meta{font-size:12px;color:#8b5a3a;display:flex;gap:10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .empty{border:1px dashed #ffc49f;border-radius:10px;padding:12px;background:#fff7ef;color:#7a3b14}
  .rightHead{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px}
</style>
</head>
<body>
<header class="header">
  <div class="inner">
    <div style="width:40px;height:40px;border-radius:10px;background:radial-gradient(100% 100% at 30% 30%,#ffd18f,#ff7f2f);display:grid;place-items:center;color:#fff;font-weight:900">💬</div>
    <strong>Lafkat</strong>
    <nav>
      <a href="index-compact.html">Bugünün Cümlesi</a>
      <a href="forum.html">Forum</a>
      <a href="leaderboard.html">Liderlik</a>
      <a href="friends.html">Arkadaşlar</a>
      <a href="profile.html">Profil</a>
      <a href="settings.html">Ayarlar</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Sol: profil bilgileri -->
  <aside class="card">
    <div class="head">
      <div class="avatar" id="avatar">🙂</div>
      <div>
        <div style="font-weight:900" id="displayName">Kullanıcı</div>
        <div class="muted" id="nickname">@takmaad</div>
        <div class="muted" id="email">ornek@posta.com</div>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <span class="pill">Toplam Puan: <b id="pointsTotal">0</b></span>
      <span class="pill">Haftalık: <b id="pointsWeekly">0</b></span>
      <span class="pill">Aylık: <b id="pointsMonthly">0</b></span>
    </div>

    <div style="margin-top:12px" class="row">
      <button class="btn secondary" id="btnEditName">Adı Düzenle</button>
      <button class="btn secondary" id="btnLogout">Çıkış Yap</button>
    </div>

    <div id="visitorNote" class="empty" style="display:none;margin-top:12px">
      Ziyaretçi modundasınız. Profil düzenlemek ve gönderi eklemek için giriş yapın.
    </div>
  </aside>

  <!-- Sağ: gönderilerim -->
  <section class="card">
    <div class="rightHead">
      <div>
        <div style="font-weight:900">Gönderilerim</div>
        <div class="muted" id="stats">0 gönderi • 0 beğeni</div>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnRefresh">Yenile</button>
      </div>
    </div>
    <div id="posts" class="list"></div>
  </section>
</main>

<footer style="max-width:1000px;margin:0 auto 20px;padding:0 16px;color:#fff;opacity:.9">
  © Lafkat • “Sözcükleri kat, eğlenceyi yakala!”
</footer>

<!-- Firebase (opsiyonel) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
/* ===== Ayarlar ===== */
let ENABLE_FIREBASE=false; // 🔴 canlıya alırken true yap
const firebaseConfig={
  // apiKey:"...", authDomain:"...", projectId:"lafkat-23687"
};

const $=s=>document.querySelector(s);
function escapeHTML(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));}
function timeAgo(d){const s=(Date.now()-d)/1000;if(s<60)return"az önce";const m=s/60;if(m<60)return`${Math.floor(m)} dk`;const h=m/60;if(h<24)return`${Math.floor(h)} sa`;return`${Math.floor(h/24)} g`;}
function firstLetters(name){const p=(name||"").trim().split(/\s+/); return (p[0]?.[0]||"")+(p[1]?.[0]||"");}

let db=null,auth=null,me=null,uid=null;
(function init(){
  if(firebaseConfig && firebaseConfig.projectId && ENABLE_FIREBASE){
    firebase.initializeApp(firebaseConfig); db=firebase.firestore(); auth=firebase.auth();
    auth.onAuthStateChanged(async user=>{
      if(!user){
        // Ziyaretçi
        $("#visitorNote").style.display="block";
        me={displayName:"Ziyaretçi", email:"", nickname:"ziyaretci"};
        renderProfile(me);
        renderPosts(DEMO_POSTS, true);
        return;
      }
      uid=user.uid;
      const userDoc = await db.collection("users").doc(uid).get();
      const data = userDoc.exists ? userDoc.data() : {};
      me = {
        displayName: user.displayName || data.displayName || "Kullanıcı",
        email: user.email || data.email || "",
        nickname: data.nickname || (user.email? user.email.split("@")[0]:""),
        points: {
          total: data.totalPoints||0,
          weekly: data.weeklyPoints||0,
          monthly: data.monthlyPoints||0
        }
      };
      renderProfile(me);
      await loadMyPosts();
    });
  }else{
    // DEMO
    me={displayName:"Demo Kullanıcı", email:"demo@lafkat.app", nickname:"democu", points:{total:120,weekly:35,monthly:90}};
    renderProfile(me);
    renderPosts(DEMO_POSTS, true);
  }
})();

/* ===== Profil render ===== */
function renderProfile(p){
  $("#displayName").textContent = p.displayName||"Kullanıcı";
  $("#nickname").textContent = "@"+(p.nickname||"takmaad");
  $("#email").textContent = p.email||"";
  $("#pointsTotal").textContent = p.points?.total||0;
  $("#pointsWeekly").textContent = p.points?.weekly||0;
  $("#pointsMonthly").textContent = p.points?.monthly||0;
  $("#avatar").textContent = (firstLetters(p.displayName)||"🙂").toUpperCase();
}

/* ===== Gönderilerim ===== */
let myPosts=[];
async function loadMyPosts(){
  if(!db||!uid) return;
  const snap = await db.collection("posts").where("uid","==", uid).orderBy("at","desc").limit(50).get();
  myPosts = snap.docs.map(d=>({ id:d.id, ...d.data(), at: d.data().at.toDate() }));
  renderPosts(myPosts);
}

function renderPosts(list, demo=false){
  const box=$("#posts"); box.innerHTML="";
  let totalLikes=0;
  if(!list.length){
    box.innerHTML = `<div class="empty">Henüz gönderiniz yok. <a href="index-compact.html">Bugünün Cümlesi</a> ile bir tane oluşturun.</div>`;
  }else{
    list.forEach(p=>{
      totalLikes += (p.likes||0);
      const el=document.createElement("div");
      el.className="item";
      el.innerHTML=`
        <div style="font-weight:800">${escapeHTML(me.displayName)}</div>
        <div class="meta"><span>@${escapeHTML(me.nickname)}</span> • <span>🕒 ${timeAgo(new Date(p.at))}</span> • <span>👍 ${p.likes||0}</span></div>
        <div style="margin:6px 0">${escapeHTML(p.text)}</div>
        <div class="actions">
          <button class="btn secondary" onclick="sharePost('${encodeURIComponent(p.text)}')">Paylaş</button>
          <button class="btn secondary" onclick="copyPost('${encodeURIComponent(p.text)}')">Kopyala</button>
          ${demo ? "" : `<button class="btn" onclick="deletePost('${p.id}')">Sil</button>`}
        </div>`;
      box.appendChild(el);
    });
  }
  $("#stats").textContent = `${list.length} gönderi • ${totalLikes} beğeni`;
}

/* ===== Paylaş / Kopyala ===== */
function sharePost(enc){
  const txt = decodeURIComponent(enc);
  const shareText = `${txt}\n\nLafkat • #SendeKatıl\n${location.origin}${location.pathname}`;
  if(navigator.share){ navigator.share({title:"Lafkat", text:shareText}).catch(()=>{}); }
  else { copyPost(enc); }
}
async function copyPost(enc){
  const txt = decodeURIComponent(enc);
  const copy = `${txt}\n\nLafkat • #SendeKatıl`;
  try{ await navigator.clipboard.writeText(copy); alert("Kopyalandı!"); }catch{ alert("Kopyalama başarısız."); }
}

/* ===== Silme ===== */
async function deletePost(postId){
  if(!db||!uid) return alert("Giriş yapmalısınız.");
  if(!confirm("Bu gönderiyi silmek istediğinizden emin misiniz?")) return;
  try{
    await db.collection("posts").doc(postId).delete();
    // listeden çıkar
    myPosts = myPosts.filter(p=>p.id!==postId);
    renderPosts(myPosts);
  }catch(e){
    alert("Silme işlemi başarısız: " + (e?.message||""));
  }
}

/* ===== Ad düzenleme ===== */
document.getElementById("btnEditName").addEventListener("click", async ()=>{
  const nv = prompt("Yeni adınızı yazın:", me?.displayName||"");
  if(!nv) return;
  if(!db || !auth || !auth.currentUser){
    me.displayName = nv; renderProfile(me); return; // DEMO
  }
  try{
    await auth.currentUser.updateProfile({ displayName: nv });
    await db.collection("users").doc(auth.currentUser.uid).set({ displayName: nv }, { merge:true });
    me.displayName = nv; renderProfile(me);
    alert("Güncellendi.");
  }catch(e){ alert("Güncellenemedi: " + (e?.message||"")); }
});

/* ===== Çıkış ===== */
document.getElementById("btnLogout").addEventListener("click", async ()=>{
  if(!auth){ alert("Demo mod: çıkış yok."); return; }
  try{
    await auth.signOut();
    localStorage.removeItem("authRole"); localStorage.removeItem("authUser");
    location.href = "login.html";
  }catch(e){ alert("Çıkış başarısız: " + (e?.message||"")); }
});

/* ===== Yenile ===== */
document.getElementById("btnRefresh").addEventListener("click", async ()=>{
  if(!db||!uid){ renderPosts(DEMO_POSTS,true); return; }
  await loadMyPosts();
});

/* ===== Demo verisi ===== */
const DEMO_POSTS=[
  { id:"d1", text:"Bugün işe giderken dondurma yüzünden geciktim.", likes:5, at:new Date(Date.now()-3*60*60*1000) },
  { id:"d2", text:"Bugün işe giderken kediyi sevmek yüzünden geciktim.", likes:2, at:new Date(Date.now()-6*60*60*1000) }
];
</script>
</body>
</html>
