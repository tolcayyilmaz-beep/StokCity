<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lafkat – Forum</title>
<meta name="description" content="Lafkat Forum – Popüler, En Yeni ve Canlı Sohbet." />
<style>
  :root{ --orange-1:#ff7a1a; --orange-2:#f36a00; --card:#fff9f2; --ink:#2b2b2b; --muted:#7b7b7b; --ring:rgba(0,0,0,.08); --shadow:0 8px 24px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.08); --radius:18px; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
        background:linear-gradient(180deg,var(--orange-1),var(--orange-2)); background-attachment:fixed;}
  .topbar{position:sticky;top:0;z-index:60;backdrop-filter:blur(6px);background:rgba(255,255,255,.30);border-bottom:1px solid rgba(255,255,255,.45)}
  .topbar-inner{max-width:1200px;margin:auto;padding:10px 16px;display:flex;align-items:center;gap:10px}
  .hamburger button{appearance:none;background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .brand img{width:34px;height:34px;border-radius:9px}
  .brand .t{font-size:22px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.28)}
  nav.hnav{margin-left:auto;display:none;gap:8px;flex-wrap:wrap}
  nav.hnav a{color:#1b1b1b;text-decoration:none;font-weight:600;background:rgba(255,255,255,.85);padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.55)}
  nav.hnav a.active{outline:3px solid rgba(255,255,255,.7)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .25s;z-index:55}
  .overlay.show{opacity:1;pointer-events:auto}
  .drawer{position:fixed;inset:0 auto 0 0;width:min(84vw,320px);background:#fff;border-right:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);
          transform:translateX(-100%);transition:transform .25s;z-index:56;display:flex;flex-direction:column}
  .drawer.open{transform:translateX(0)}
  .drawer .head{padding:16px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;gap:10px}
  .drawer nav{display:grid;gap:8px;padding:12px}
  .drawer nav a{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);text-decoration:none;color:#1b1b1b;background:#fff;font-weight:700}
  .drawer .foot{margin-top:auto;padding:12px;border-top:1px solid rgba(0,0,0,.06)}
  @media (min-width:980px){ nav.hnav{display:flex}.hamburger{display:none} }
  .wrap{max-width:1000px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--ring)}
  .card .hd{padding:14px 16px;border-bottom:1px solid rgba(0,0,0,.06);font-weight:800}
  .card .bd{padding:14px 16px}
  .tabs{display:flex;gap:6px;padding:8px;background:rgba(255,255,255,.55);border-bottom:1px solid rgba(0,0,0,.06)}
  .tab{flex:1;padding:10px;border:0;border-radius:12px;font-weight:800;cursor:pointer;background:#fff}
  .tab[aria-selected="true"]{background:linear-gradient(180deg,#ffb37a,#ff8e3a)}
  .post{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:12px;margin-bottom:12px}
  .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
  .vote{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .btn{padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:#fff;cursor:pointer}
  .btn:hover{background:#f8f8f8}
  .loadmore{text-align:center;margin:14px 0}
  .hint{font-size:12px;color:var(--muted)}
  .hidden{display:none}
  /* Chat */
  .chat-wrap{display:flex;flex-direction:column;gap:10px}
  .chat-messages{max-height:360px;overflow-y:auto;display:flex;flex-direction:column-reverse;gap:8px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:10px}
  .chat-row{display:flex;gap:8px;align-items:flex-start}
  textarea.chat-input{flex:1;resize:none;padding:8px;border:1px solid rgba(0,0,0,.12);border-radius:10px}
</style>
</head>
<body>
  <!-- Overlay & Drawer -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-hidden="true" aria-label="Menü">
    <div class="head"><img src="assets/logo.png" alt="" width="28" height="28" onerror="this.style.display='none'"><strong>Lafkat Menü</strong></div>
    <nav>
      <a href="index.html">Anasayfa</a>
      <a href="forum.html">Forum</a>
      <a href="liderlik.html">Liderlik</a>
      <a href="arkadaslar.html">Arkadaşlar</a>
      <a href="profil.html">Profil</a>
      <a href="ayarlar.html">Ayarlar</a>
      <a href="#" id="adminLink1" style="display:none">Admin Yönetimi</a>
    </nav>
    <div class="foot"><a href="#" id="logoutDrawer" style="text-decoration:none;color:#b12020;font-weight:800">Çıkış</a></div>
  </aside>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="hamburger"><button id="menuBtn" aria-label="Menüyü aç" aria-expanded="false" aria-controls="drawer">☰ Menü</button></div>
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="Lafkat" onerror="this.style.display='none'"><span class="t">Lafkat</span>
      </a>
      <nav class="hnav">
        <a href="index.html">Anasayfa</a>
        <a class="active" href="forum.html">Forum</a>
        <a href="liderlik.html">Liderlik</a>
        <a href="arkadaslar.html">Arkadaşlar</a>
        <a href="profil.html">Profil</a>
        <a href="ayarlar.html">Ayarlar</a>
        <a href="#" id="adminLink2" style="display:none">Admin Yönetimi</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="card" aria-labelledby="forumTitle">
      <div class="hd" id="forumTitle">Forum</div>

      <div class="tabs" role="tablist" aria-label="Forum sekmeleri">
        <button class="tab" role="tab" id="tab-pop" aria-selected="true" aria-controls="panel-pop">Popüler (Bugün)</button>
        <button class="tab" role="tab" id="tab-new" aria-selected="false" aria-controls="panel-new">En Yeni</button>
        <button class="tab" role="tab" id="tab-chat" aria-selected="false" aria-controls="panel-chat">Canlı Sohbet</button>
      </div>

      <div class="bd">
        <div id="panel-pop" role="tabpanel" aria-labelledby="tab-pop">
          <div id="popFeed"></div>
          <div class="loadmore"><button class="btn" id="popMore">Daha Fazla Yükle</button></div>
        </div>

        <div id="panel-new" role="tabpanel" aria-labelledby="tab-new" class="hidden">
          <div id="newFeed"></div>
          <div class="loadmore"><button class="btn" id="newMore">Daha Fazla Yükle</button></div>
        </div>

        <div id="panel-chat" role="tabpanel" aria-labelledby="tab-chat" class="hidden">
          <div class="chat-wrap">
            <div class="chat-messages" id="chatBox" aria-live="polite"></div>
            <div class="chat-row">
              <textarea id="chatInput" class="chat-input" rows="2" placeholder="Mesajını yaz... (Enter: Gönder · Shift+Enter: Yeni satır)"></textarea>
              <button class="btn" id="sendChat">Gönder</button>
            </div>
            <div class="hint">Enter = gönder, Shift+Enter = satır sonu.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
  // Drawer & UI
  const menuBtn=document.getElementById('menuBtn');
  const drawer=document.getElementById('drawer');
  const overlay=document.getElementById('overlay');
  function openDrawer(){drawer.classList.add('open');overlay.classList.add('show');menuBtn.setAttribute('aria-expanded','true');document.body.style.overflow='hidden'; drawer.querySelector('a').focus();}
  function closeDrawer(){drawer.classList.remove('open');overlay.classList.remove('show');menuBtn.setAttribute('aria-expanded','false');document.body.style.overflow='';}
  menuBtn.addEventListener('click', ()=> drawer.classList.contains('open')?closeDrawer():openDrawer());
  overlay.addEventListener('click', closeDrawer);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape' && drawer.classList.contains('open')) closeDrawer(); });

  // Tabs
  const tabs=[{btn:'tab-pop',panel:'panel-pop'},{btn:'tab-new',panel:'panel-new'},{btn:'tab-chat',panel:'panel-chat'}];
  function switchTo(id){tabs.forEach(t=>{const b=document.getElementById(t.btn),p=document.getElementById(t.panel);const on=t.btn===id;b.setAttribute('aria-selected',on?'true':'false');p.classList.toggle('hidden',!on);});}
  tabs.forEach(t=>document.getElementById(t.btn).addEventListener('click',()=>switchTo(t.btn)));
</script>

<!-- Firebase entegrasyonu -->
<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
  import {
    collection, doc, getDoc, addDoc, setDoc, deleteDoc, getDocs, onSnapshot,
    query, where, orderBy, limit, startAfter, serverTimestamp,
    getAggregateFromServer, count
  } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

  /* DOM referansları */
  const adminLink1 = document.getElementById('adminLink1');
  const adminLink2 = document.getElementById('adminLink2');
  const logoutDrawer = document.getElementById('logoutDrawer');

  /* Auth guard */
  let me=null, meProfile=null, activeSentenceId=null;
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href='giris.html?next=forum.html'; return; }
    me=user;

    try{
      const token=await getIdTokenResult(user,true);
      if(token.claims?.admin){
        adminLink1.style.display=adminLink2.style.display='inline-block';
        adminLink1.href=adminLink2.href='admin.html';
      }
    }catch(_){}

    try{
      const u=await getDoc(doc(db,'users', user.uid));
      meProfile=u.exists()?u.data():null;
    }catch(_){}

    await loadActiveSentence();
    await loadPopular(true);
    await loadNewest(true);
    bindChat();
  });

  /* Çıkış */
  logoutDrawer.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{ await signOut(auth); }catch(_){}
    location.href='giris.html';
  });

  /* Aktif cümle (isActive yoksa son oluşturulana, o da yoksa bugünün ID’sine düş) */
  async function loadActiveSentence(){
    try{
      const r1 = await getDocs(
        query(collection(db,'sentences'), where('isActive','==',true), orderBy('createdAt','desc'), limit(1))
      );
      if(!r1.empty){ activeSentenceId=r1.docs[0].id; console.log('[Forum] activeSentenceId (isActive):',activeSentenceId); return; }
    }catch(e){ console.warn('[Forum] isActive query failed:', e); }

    try{
      const r2 = await getDocs(
        query(collection(db,'sentences'), orderBy('createdAt','desc'), limit(1))
      );
      if(!r2.empty){ activeSentenceId=r2.docs[0].id; console.log('[Forum] activeSentenceId (latest):',activeSentenceId); return; }
    }catch(e){ console.warn('[Forum] latest sentence query failed:', e); }

    activeSentenceId=(new Date()).toISOString().slice(0,10);
    console.log('[Forum] fallback activeSentenceId (today):', activeSentenceId);
  }

  /* ------- FEED ------- */
  const popFeed=document.getElementById('popFeed');
  const newFeed=document.getElementById('newFeed');
  const popMore=document.getElementById('popMore');
  const newMore=document.getElementById('newMore');
  let popCursor=null, newCursor=null;

  function postHTML(id, x){
    const text = escapeHtml(String(x.text||''));
    const nick = x.nickname || 'Anonim';
    return `
      <article class="post" data-id="${id}">
        <div class="meta">@${nick}</div>
        ${text}
        <div class="vote">
          <button class="btn" data-vote="like">👍 <span class="lk">${x.likes||0}</span></button>
          <button class="btn" data-vote="dislike">👎 <span class="dk">${x.dislikes||0}</span></button>
        </div>
      </article>`;
  }

  async function loadPopular(reset=false){
    if(!activeSentenceId) return;
    if(reset){ popFeed.innerHTML=''; popCursor=null; popMore.disabled=false; }
    try{
      const qy = popCursor
        ? query(collection(db,'completions'), where('sentenceId','==',activeSentenceId),
                orderBy('likes','desc'), orderBy('createdAt','desc'),
                startAfter(popCursor), limit(10))
        : query(collection(db,'completions'), where('sentenceId','==',activeSentenceId),
                orderBy('likes','desc'), orderBy('createdAt','desc'), limit(10));
      const snap=await getDocs(qy);
      if(snap.empty && reset){ popFeed.innerHTML='<div class="hint">Henüz gönderi yok</div>'; popMore.disabled=true; return; }
      if(!snap.empty){
        popCursor = snap.docs[snap.docs.length-1];
        snap.forEach(d=> popFeed.insertAdjacentHTML('beforeend', postHTML(d.id, d.data())));
        if(snap.size < 10) popMore.disabled = true;
      }
    }catch(err){
      console.error('[Forum] loadPopular error:', err);
      popFeed.innerHTML = `<div class="hint">Yüklenemedi: ${err.code || err.message}</div>`;
      popMore.disabled = true;
    }
  }

  async function loadNewest(reset=false){
    if(!activeSentenceId) return;
    if(reset){ newFeed.innerHTML=''; newCursor=null; newMore.disabled=false; }
    try{
      const qy = newCursor
        ? query(collection(db,'completions'), where('sentenceId','==',activeSentenceId),
                orderBy('createdAt','desc'), startAfter(newCursor), limit(10))
        : query(collection(db,'completions'), where('sentenceId','==',activeSentenceId),
                orderBy('createdAt','desc'), limit(10));
      const snap=await getDocs(qy);
      if(snap.empty && reset){ newFeed.innerHTML='<div class="hint">Henüz gönderi yok</div>'; newMore.disabled=true; return; }
      if(!snap.empty){
        newCursor = snap.docs[snap.docs.length-1];
        snap.forEach(d=> newFeed.insertAdjacentHTML('beforeend', postHTML(d.id, d.data())));
        if(snap.size < 10) newMore.disabled = true;
      }
    }catch(err){
      console.error('[Forum] loadNewest error:', err);
      newFeed.innerHTML = `<div class="hint">Yüklenemedi: ${err.code || err.message}</div>`;
      newMore.disabled = true;
    }
  }

  popMore.addEventListener('click', ()=>loadPopular(false));
  newMore.addEventListener('click', ()=>loadNewest(false));

  /* ---- Oy tekilleştirme ---- */
  async function getVoteCounts(completionId){
    const base=collection(db,'completions', completionId, 'votes');
    const likeAgg = await getAggregateFromServer(query(base, where('type','==','like')), { likeCount: count() });
    const dislikeAgg = await getAggregateFromServer(query(base, where('type','==','dislike')), { dislikeCount: count() });
    return { likes: likeAgg.data().likeCount||0, dislikes: dislikeAgg.data().dislikeCount||0 };
  }
  async function toggleVote(completionId, type){
    if(!me) return;
    const ref=doc(db,'completions', completionId, 'votes', me.uid);
    const snap=await getDoc(ref);
    const now=serverTimestamp();
    if(!snap.exists()){ return setDoc(ref, { type, createdAt: now, updatedAt: now }); }
    const prev=snap.data()?.type;
    if(prev===type) return deleteDoc(ref);
    return setDoc(ref, { type, createdAt: snap.data()?.createdAt||now, updatedAt: now });
  }
  function bindVoteDelegation(container){
    container.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-vote]');
      if(!btn) return;
      const article = btn.closest('article.post');
      const cid = article?.dataset?.id;
      const type = btn.getAttribute('data-vote');
      try{
        await toggleVote(cid, type);
        const c = await getVoteCounts(cid);
        article.querySelector('.lk').textContent=c.likes;
        article.querySelector('.dk').textContent=c.dislikes;
      }catch(err){ console.error('[vote]', err); }
    });
  }
  bindVoteDelegation(popFeed);
  bindVoteDelegation(newFeed);

  /* ---- Canlı sohbet ---- */
  const chatBox=document.getElementById('chatBox');
  const chatInput=document.getElementById('chatInput');
  const sendChat=document.getElementById('sendChat');

  function renderMsg(d){
    const x=d.data();
    const who = escapeHtml(x.nickname || 'Anonim');
    const txt = escapeHtml(String(x.text||''));
    return `<div><strong>@${who}</strong>: ${txt}</div>`;
  }
  function bindChat(){
    const qChat=query(collection(db,'forum_messages'), orderBy('createdAt','desc'), limit(50));
    onSnapshot(qChat, (snap)=>{
      chatBox.innerHTML='';
      snap.forEach(docu => chatBox.insertAdjacentHTML('beforeend', renderMsg(docu)));
    }, (err)=>{
      console.error('[Forum] chat subscribe error:', err);
      chatBox.innerHTML = `<div class="hint">Sohbet yüklenemedi: ${err.code || err.message}</div>`;
    });

    async function send(){
      const v=(chatInput.value||'').trim(); if(!v) return;
      try{
        await addDoc(collection(db,'forum_messages'), {
          uid: me.uid, nickname: meProfile?.nickname || 'Anonim',
          text: v, createdAt: serverTimestamp()
        });
        chatInput.value=''; chatInput.focus();
      }catch(err){
        console.error('[Forum] chat send error:', err);
        alert('Sohbet mesajı gönderilemedi: ' + (err.code || err.message));
      }
    }
    sendChat.addEventListener('click', send);
    chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });
  }

  /* util */
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>

<!-- Firebase init -->
<script type="module"> import "./firebase-init.js"; </script>
</body>
</html>
