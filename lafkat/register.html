<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lafkat â€“ KayÄ±t Ol</title>
<meta name="theme-color" content="#FF7F2F" />
<style>
  :root{--orange:#FF7F2F;--orange-2:#ff9a58;--ink:#1b1b1b;--line:#ffd7bf}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;display:grid;place-items:center;padding:24px;
    font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,var(--orange) 0%,var(--orange-2) 100%);color:var(--ink)}
  .card{width:min(760px,100%);background:#fff;border:1px solid var(--line);border-radius:18px;
    box-shadow:0 18px 48px rgba(255,127,47,.28);padding:18px}
  .head{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .logo{width:48px;height:48px;border-radius:12px;background:radial-gradient(100% 100% at 30% 30%,#ffd18f,#ff7f2f);
    display:grid;place-items:center;color:#fff;font-weight:900}
  h1{margin:0;font-size:24px}
  .row{display:grid;gap:8px;margin-top:10px}
  label{font-weight:700;font-size:13px;color:#7a3b14}
  input{width:100%;padding:12px;border:1.6px solid #ffd0b3;border-radius:12px;font-size:15px;outline:none}
  input:focus{border-color:#ff9a58;box-shadow:0 0 0 4px #ffe7d7}
  .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media(max-width:720px){.grid{grid-template-columns:1fr}}
  .hint{font-size:12px;color:#8b5a3a}
  .error{font-size:12px;color:#b00020}
  .ok{font-size:12px;color:#0c7a43}
  .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  .btn{cursor:pointer;border:none;background:#FF7F2F;color:#fff;padding:12px 16px;border-radius:12px;font-weight:800}
  .btn.secondary{background:#fff;color:#ff6a08;border:1.6px solid #ffd0b3}
  .note{font-size:12px;color:#7a3b14;margin-top:6px}
</style>
</head>
<body>
<div class="card">
  <div class="head">
    <div class="logo">ðŸ’¬</div>
    <div>
      <h1>KayÄ±t Ol</h1>
      <div id="modeTag" class="hint">demo (offline)</div>
    </div>
  </div>

  <form id="form" autocomplete="on">
    <div class="grid">
      <div class="row">
        <label for="displayName">Ad Soyad</label>
        <input id="displayName" type="text" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" required />
      </div>
      <div class="row">
        <label for="nickname">KullanÄ±cÄ± AdÄ± (benzersiz)</label>
        <input id="nickname" type="text" placeholder="or: lafkatci" required />
        <div id="nickHelp" class="hint">Sadece harf, sayÄ± ve alt Ã§izgi kullanÄ±n. En az 3 karakter.</div>
      </div>
    </div>

    <div class="row">
      <label for="email">E-posta</label>
      <input id="email" type="email" placeholder="ornek@posta.com" required />
    </div>

    <div class="grid">
      <div class="row">
        <label for="password">Åžifre</label>
        <input id="password" type="password" placeholder="En az 8 karakter" required />
        <div id="passHelp" class="hint">En az 8 karakter; gÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in.</div>
      </div>
      <div class="row">
        <label for="password2">Åžifre (tekrar)</label>
        <input id="password2" type="password" placeholder="Åžifrenizi tekrar yazÄ±n" required />
        <div id="match" class="hint"></div>
      </div>
    </div>

    <div class="row">
      <label style="display:flex;gap:8px;align-items:flex-start">
        <input id="terms" type="checkbox" required />
        <span>KurallarÄ± ve gizlilik ÅŸartlarÄ±nÄ± kabul ediyorum.</span>
      </label>
    </div>

    <div id="msg" class="error" role="alert"></div>

    <div class="actions">
      <button class="btn" type="submit" id="btnRegister">KayÄ±t Ol</button>
      <a class="btn secondary" href="login.html">GiriÅŸe DÃ¶n</a>
    </div>
    <div class="note">KayÄ±t sonrasÄ± otomatik giriÅŸ yapÄ±lÄ±r ve ana sayfaya yÃ¶nlendirilirsiniz.</div>
  </form>
</div>

<!-- Firebase (opsiyonel) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
/* ===== Ayarlar ===== */
let ENABLE_FIREBASE = true; // canlÄ±ya alÄ±nca true yap
const firebaseConfig = {
  apiKey: "AIzaSyB5VbgogKUo8RXeA8SUMUaHVbbblAg4gfE",
  authDomain: "lafkat-23687.firebaseapp.com",
  projectId: "lafkat-23687",
  storageBucket: "lafkat-23687.firebasestorage.app",
  messagingSenderId: "493504696765",
  appId: "1:493504696765:web:86bb6f7a28e403efc782d4"
};
const PATH_AFTER_REGISTER = "index-compact.html";

const $ = s=>document.querySelector(s);
const show = (el, text, cls)=>{ el.textContent = text||""; el.className = cls||el.className; };

let db=null, auth=null;
(function init(){
  if(firebaseConfig && firebaseConfig.projectId && ENABLE_FIREBASE){
    firebase.initializeApp(firebaseConfig); db=firebase.firestore(); auth=firebase.auth();
    $("#modeTag").textContent = "canlÄ± (Firebase)";
  }
})();

/* ===== Basit doÄŸrulamalar ===== */
function normNick(v){ return (v||"").toLowerCase().trim().replace(/[^a-z0-9_]/g,""); }
function nickValid(v){ return /^[a-z0-9_]{3,20}$/.test(v); }
function passStrong(v){ return (v||"").length>=8; }

$("#nickname").addEventListener("input", ()=>{
  const raw = $("#nickname").value;
  const n = normNick(raw);
  if(raw!==n) $("#nickname").value = n;
  if(!nickValid(n)) show($("#nickHelp"), "Sadece a-z, 0-9, _ ve en az 3 karakter.", "error");
  else show($("#nickHelp"), "Uygun gÃ¶rÃ¼nÃ¼yor.", "ok");
});

$("#password2").addEventListener("input", ()=>{
  const ok = $("#password").value === $("#password2").value;
  show($("#match"), ok ? "Åžifreler eÅŸleÅŸiyor." : "Åžifreler eÅŸleÅŸmiyor.", ok ? "ok" : "error");
});

/* ===== KayÄ±t akÄ±ÅŸÄ± ===== */
document.getElementById("form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  $("#msg").textContent = "";

  const displayName = $("#displayName").value.trim();
  const nicknameRaw = $("#nickname").value.trim();
  const nickname = normNick(nicknameRaw);
  const email = $("#email").value.trim();
  const pass = $("#password").value;
  const pass2 = $("#password2").value;
  const terms = $("#terms").checked;

  if(!displayName || !nickValid(nickname) || !email || !passStrong(pass) || pass!==pass2 || !terms){
    return $("#msg").textContent = "LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldurun.";
  }

  if(!db || !auth){
    // DEMO MODU: sadece yerelde kaydedip yÃ¶nlendiriyoruz
    localStorage.setItem("authRole","user");
    localStorage.setItem("authUser", JSON.stringify({ email, displayName, nickname }));
    alert("Demo mod: KayÄ±t tamamlandÄ±.");
    return location.href = PATH_AFTER_REGISTER;
  }

  try{
    // 1) Nickname benzersiz mi?
    const profRef = db.collection("profiles").doc(nickname);
    const profDoc = await profRef.get();
    if(profDoc.exists){
      return $("#msg").textContent = "Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ. LÃ¼tfen baÅŸka bir tane deneyin.";
    }

    // 2) Auth kullanÄ±cÄ±sÄ± oluÅŸtur
    const { user } = await auth.createUserWithEmailAndPassword(email, pass);
    await user.updateProfile({ displayName });

    // 3) users koleksiyonuna yaz
    await db.collection("users").doc(user.uid).set({
      email, displayName, nickname,
      roles: { admin:false, mod:false },
      totalPoints: 0, weeklyPoints: 0, monthlyPoints: 0,
      createdAt: firebase.firestore.Timestamp.now()
    });

    // 4) profiles (docId = nickname) â€“ benzersiz
    await profRef.set({
      uid: user.uid, displayName, createdAt: firebase.firestore.Timestamp.now()
    });

    // 5) Oturumu iÅŸaretle ve yÃ¶nlendir
    localStorage.setItem("authRole","user");
    localStorage.setItem("authUser", JSON.stringify({ uid:user.uid, email, displayName, nickname }));
    alert("KayÄ±t tamamlandÄ±. HoÅŸ geldiniz!");
    location.href = PATH_AFTER_REGISTER;

  }catch(err){
    console.error(err);
    $("#msg").textContent = err && err.message ? err.message : "KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu.";
  }
});
</script>
</body>
</html>
