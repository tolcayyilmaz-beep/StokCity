<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lafkat – Anasayfa</title>
<meta name="description" content="Lafkat – Günün boşluğunu doldur! Yaratıcı cümle tamamlamaları, beğeni ve paylaşım." />
<style>
  :root{
    --orange-1:#ff7a1a; --orange-2:#f36a00;
    --card:#fff9f2; --ink:#2b2b2b; --muted:#7b7b7b; --ring:rgba(0,0,0,.08);
    --shadow:0 8px 24px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.08);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
    background:
      radial-gradient(90vmax 90vmax at 100% -10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(180deg,var(--orange-1),var(--orange-2));
    background-attachment:fixed;
  }
  /* Topbar */
  .topbar{position:sticky;top:0;z-index:60;backdrop-filter:blur(6px);background:rgba(255,255,255,.30);border-bottom:1px solid rgba(255,255,255,.45)}
  .topbar-inner{max-width:1200px;margin:auto;padding:10px 16px;display:flex;align-items:center;gap:10px}
  .hamburger{display:flex;align-items:center}
  .hamburger button{appearance:none;background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
  .brand img{width:34px;height:34px;border-radius:9px;box-shadow:0 6px 14px rgba(0,0,0,.25)}
  .brand .t{font-size:22px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.28)}
  nav.hnav{margin-left:auto;display:none;gap:8px;flex-wrap:wrap}
  nav.hnav a{color:#1b1b1b;text-decoration:none;font-weight:600;background:rgba(255,255,255,.85);padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.55)}
  nav.hnav a.active{outline:3px solid rgba(255,255,255,.7)}
  /* Drawer */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .25s;z-index:55}
  .overlay.show{opacity:1;pointer-events:auto}
  .drawer{position:fixed;inset:0 auto 0 0;width:min(84vw,320px);background:#fff;border-right:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);
          transform:translateX(-100%);transition:transform .25s;z-index:56;display:flex;flex-direction:column}
  .drawer.open{transform:translateX(0)}
  .drawer .head{padding:16px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;align-items:center;gap:10px}
  .drawer .head .title{font-weight:900}
  .drawer nav{display:grid;gap:8px;padding:12px}
  .drawer nav a{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);text-decoration:none;color:#1b1b1b;background:#fff;font-weight:700}
  .drawer .foot{margin-top:auto;padding:12px;border-top:1px solid rgba(0,0,0,.06)}
  /* Layout */
  .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
  .grid{display:grid;gap:18px;grid-template-columns: 1fr 360px}
  @media (min-width:980px){ nav.hnav{display:flex}.hamburger{display:none} }
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  /* Cards */
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--ring)}
  .card .hd{padding:16px 18px;border-bottom:1px solid rgba(0,0,0,.06);font-weight:800}
  .card .bd{padding:16px 18px}
  /* Home specifics */
  .daily{background:linear-gradient(180deg,#fff,#fff7ef);border-radius:16px;padding:16px;border:1px dashed rgba(0,0,0,.08)}
  .daily .label{font-size:13px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.6px}
  .daily .sentence{font-size:22px;line-height:1.4;margin-top:6px;font-weight:800}
  textarea{width:100%;min-height:120px;resize:vertical;font:inherit;padding:12px 14px;border:1.5px solid rgba(0,0,0,.12);border-radius:14px;background:#fff;outline:none}
  textarea:focus{border-color:#ff8a2c;box-shadow:0 0 0 4px rgba(255,138,44,.18)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.15)}
  .btn-primary{background:linear-gradient(180deg,#ffb37a,#ff8e3a);color:#3a240e}
  .btn-ghost{background:#fff;color:#1b1b1b;border:1px solid rgba(0,0,0,.08)}
  .hint{font-size:13px;color:var(--muted);margin-left:auto}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:999px;font-weight:700}
  .mini{display:grid;gap:10px}
  .mini .item{display:flex;gap:12px;align-items:center;padding:10px;background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px}
  .avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(180deg,#ffe0c6,#ffbf88);border:1px solid rgba(0,0,0,.08);display:grid;place-items:center;font-weight:800;color:#7a4a16;box-shadow: inset 0 0 0 2px rgba(255,255,255,.7)}
  .list{display:grid;gap:10px}
  .list .rowitem{background:#fff;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,.06)}
  .weekly{display:flex;align-items:center;gap:12px;background:linear-gradient(180deg,#fff,#fff3e6);padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08)}
  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;opacity:0;pointer-events:none;transition:opacity .25s;z-index:70}
  .toast.show{opacity:1}
  .disabled{opacity:.6;pointer-events:none}
</style>
</head>
<body>
  <!-- Overlay & Drawer -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-hidden="true" aria-label="Menü">
    <div class="head">
      <img src="assets/logo.png" alt="" width="28" height="28" onerror="this.style.display='none'">
      <div class="title">Lafkat Menü</div>
    </div>
    <nav>
      <a href="index.html">Anasayfa</a>
      <a href="forum.html">Forum</a>
      <a href="liderlik.html">Liderlik</a>
      <a href="arkadaslar.html">Arkadaşlar</a>
      <a href="profil.html">Profil</a>
      <a href="ayarlar.html">Ayarlar</a>
      <a href="#" id="adminLink1" style="display:none">Admin Yönetimi</a>
    </nav>
    <div class="foot">
      <a href="#" id="logoutBtn" style="display:inline-block;text-decoration:none;color:#b12020;font-weight:800">Çıkış</a>
    </div>
  </aside>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="hamburger">
        <button id="menuBtn" aria-label="Menüyü aç" aria-expanded="false" aria-controls="drawer">☰ Menü</button>
      </div>
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="Lafkat" onerror="this.style.display='none'">
        <span class="t">Lafkat</span>
      </a>
      <nav class="hnav" aria-label="Ana menü">
        <a class="active" href="index.html">Anasayfa</a>
        <a href="forum.html">Forum</a>
        <a href="liderlik.html">Liderlik</a>
        <a href="arkadaslar.html">Arkadaşlar</a>
        <a href="profil.html">Profil</a>
        <a href="ayarlar.html">Ayarlar</a>
        <a href="#" id="adminLink2" style="display:none">Admin Yönetimi</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="weekly card" role="note" aria-label="Haftanın Lafkatçısı">
      <div class="avatar">G</div>
      <div>
        <div class="hint" style="margin:0">Haftanın Lafkatçısı</div>
        <strong>@GunesliKahve</strong>
        <div class="hint" style="margin:0">Bu hafta en çok beğeni alan kullanıcı</div>
      </div>
    </div>

    <div class="grid" style="margin-top:18px">
      <section class="card">
        <div class="hd">Günün Cümlesi</div>
        <div class="bd">
          <div class="daily" id="dailyBox">
            <div class="label">Bugün</div>
            <div class="sentence" id="dailySentence">...</div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="chip">Kalan hak: <span id="quota">0</span>/5</div>
            <div class="chip">#SendeKatıl</div>
            <span class="hint" id="counter">0/240</span>
          </div>

          <label class="hint" for="completion" style="display:block;margin-top:6px">Cümleni yaz:</label>
          <textarea id="completion" maxlength="240" placeholder="Boşluğu yaratıcı bir şekilde tamamla..."></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn btn-primary" id="sendBtn" disabled>Gönder</button>
            <button class="btn btn-ghost" id="shareBtn">Paylaş</button>
            <button class="btn btn-ghost" id="copyBtn">Kopyala</button>
          </div>
        </div>
      </section>

      <aside aria-label="Sağ panel" class="card">
        <div class="hd">Bugünün İlk 3’ü</div>
        <div class="bd mini" id="top3"></div>

        <div class="hd">Son 10 Gönderi</div>
        <div class="bd list" id="latestList"></div>
      </aside>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
  /* Drawer + UI yardımcıları */
  const menuBtn = document.getElementById('menuBtn');
  const drawer = document.getElementById('drawer');
  const overlay = document.getElementById('overlay');
  function openDrawer(){drawer.classList.add('open');overlay.classList.add('show');menuBtn.setAttribute('aria-expanded','true');document.body.style.overflow='hidden'; drawer.querySelector('a').focus();}
  function closeDrawer(){drawer.classList.remove('open');overlay.classList.remove('show');menuBtn.setAttribute('aria-expanded','false');document.body.style.overflow='';}
  menuBtn.addEventListener('click', ()=> drawer.classList.contains('open')?closeDrawer():openDrawer());
  overlay.addEventListener('click', closeDrawer);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape' && drawer.classList.contains('open')) closeDrawer(); });

  const completion=document.getElementById('completion'), counter=document.getElementById('counter');
  completion.addEventListener('input', ()=> counter.textContent=`${completion.value.length}/240`);
  const toast=(m)=>{const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)};
  function copyText(txt){navigator.clipboard?.writeText(txt).then(()=>toast('Kopyalandı'));}
  copyBtn.addEventListener('click', ()=> copyText(`Lafkat: ${document.getElementById('dailySentence').innerText.replace(/\s+/g,' ').trim()} #SendeKatıl`));
  shareBtn.addEventListener('click', async ()=>{
    const text=`Lafkat: ${document.getElementById('dailySentence').innerText.replace(/\s+/g,' ').trim()} #SendeKatıl`;
    const data={title:'Lafkat', text, url:location.href};
    try{ if(navigator.share) await navigator.share(data); else copyText(`${text} ${location.href}`);}catch(e){}
  });
</script>

<!-- 🔐 Auth + Firestore -->
<script type="module">
  import { auth, db } from "./firebase-init.js";
  import {
    onAuthStateChanged, signOut, getIdTokenResult
  } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
  import {
    doc, getDoc, setDoc, deleteDoc,
    addDoc, collection, query, where, orderBy, limit, getDocs,
    serverTimestamp, getAggregateFromServer, count
  } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

  const adminLink1=document.getElementById('adminLink1');
  const adminLink2=document.getElementById('adminLink2');
  const logoutBtn=document.getElementById('logoutBtn');
  const sendBtn=document.getElementById('sendBtn');
  const quotaEl=document.getElementById('quota');
  const sentenceEl=document.getElementById('dailySentence');

  let currentUser=null, currentProfile=null, currentSentenceId=null;

  /* === Auth akışı === */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href='giris.html?next=index.html'; return; }
    currentUser=user;

    try{
      const token=await getIdTokenResult(user,true);
      if(token.claims?.admin){
        adminLink1.style.display=adminLink2.style.display='inline-block';
        adminLink1.href=adminLink2.href='admin.html';
      }
    }catch(e){}

    if(!user.emailVerified){
      sendBtn.disabled=true; sendBtn.classList.add('disabled'); sendBtn.title='E-posta doğrulanmamış';
    }

    try{
      const uref=doc(db,'users',user.uid);
      const usnap=await getDoc(uref);
      currentProfile=usnap.exists()?usnap.data():null;
    }catch(e){ console.warn('[UserProfile]', e); }

    await loadSentence();
    await refreshQuota();
    await fillSidebars();
  });

  logoutBtn.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{ await signOut(auth); }catch(_){}
    location.href='giris.html';
  });

  /* === Günün cümlesi === */
  async function loadSentence(){
    sentenceEl.textContent='Yükleniyor...';
    currentSentenceId=null;

    // isActive == true, en yeni
    try{
      const q1=query(collection(db,'sentences'), where('isActive','==',true), orderBy('createdAt','desc'), limit(1));
      const r1=await getDocs(q1);
      if(!r1.empty){
        const d=r1.docs[0];
        currentSentenceId=d.id;
        sentenceEl.innerHTML=(d.data().text||'').toString();
        return;
      }
    }catch(e){ console.warn('[Sentences active]', e); }

    // fallback: YYYY-MM-DD ID’li doküman
    try{
      const id=(new Date()).toISOString().slice(0,10); // YYYY-MM-DD
      const ds=await getDoc(doc(db,'sentences', id));
      if(ds.exists()){
        currentSentenceId=id;
        sentenceEl.innerHTML=(ds.data().text||'').toString();
        return;
      }
    }catch(e){ console.warn('[Sentences today]', e); }

    sentenceEl.textContent='Bugün için cümle bulunamadı.';
  }

  /* === Günlük 5 hak === */
  async function refreshQuota(){
    if(!currentUser || !currentSentenceId){ quotaEl.textContent='0'; return; }
    try{
      const qC=query(
        collection(db,'completions'),
        where('userId','==', currentUser.uid),
        where('sentenceId','==', currentSentenceId)
      );
      const snap=await getDocs(qC);
      const used=snap.size;
      const remain=Math.max(0, 5 - used);
      quotaEl.textContent=remain;

      if(currentUser.emailVerified && remain>0){
        sendBtn.disabled=false; sendBtn.classList.remove('disabled'); sendBtn.title='';
      }else{
        sendBtn.disabled=true; sendBtn.classList.add('disabled');
        sendBtn.title = !currentUser.emailVerified ? 'E-posta doğrulanmamış' : 'Günlük hakkın doldu';
      }
    }catch(e){
      console.error('[Quota]', e);
      quotaEl.textContent='0';
      sendBtn.disabled=true; sendBtn.classList.add('disabled');
    }
  }

  /* === Gönderi ekleme === */
  sendBtn.addEventListener('click', async ()=>{
    const v=document.getElementById('completion').value.trim();
    if(!v) return window.toast?.('Lütfen cümleni yaz.');
    if(!currentUser) return;
    if(!currentUser.emailVerified) return window.toast?.('E-postanı doğrulamalısın');
    if(!currentSentenceId) return window.toast?.('Bugünün cümlesi yüklenemedi');

    const remain=parseInt(document.getElementById('quota').textContent||'0',10);
    if(remain<=0) return window.toast?.('Günlük hakkın doldu');

    try{
      await addDoc(collection(db,'completions'), {
        sentenceId: currentSentenceId,
        userId: currentUser.uid,
        nickname: currentProfile?.nickname || 'Anonim',
        text: v,
        likes: 0,
        dislikes: 0,
        createdAt: serverTimestamp()
      });
      document.getElementById('completion').value='';
      document.getElementById('counter').textContent='0/240';
      window.toast?.('Gönderildi');
      await refreshQuota();
      await fillSidebars();
    }catch(err){
      console.error('[AddCompletion]', err);
      window.toast?.('Gönderilemedi: ' + (err.code||err.message));
    }
  });

  /* === Oy sayımı (aggregate) === */
  async function getVoteCounts(completionId){
    const base=collection(db,'completions', completionId, 'votes');
    const likeAgg = await getAggregateFromServer(query(base, where('type','==','like')), { likeCount: count() });
    const dislikeAgg = await getAggregateFromServer(query(base, where('type','==','dislike')), { dislikeCount: count() });
    return {
      likes: likeAgg.data().likeCount || 0,
      dislikes: dislikeAgg.data().dislikeCount || 0
    };
  }

  /* === Oy tekilleştirme === */
  async function toggleVote(completionId, type){ // 'like' | 'dislike'
    if(!currentUser) return window.toast?.('Önce giriş yapmalısın');
    const myVoteRef = doc(db, 'completions', completionId, 'votes', currentUser.uid);
    const snap = await getDoc(myVoteRef);
    const now  = serverTimestamp();

    if(!snap.exists()){
      await setDoc(myVoteRef, { type, createdAt: now, updatedAt: now });
      return { changed:true };
    }
    const prev = snap.data()?.type;
    if(prev === type){
      await deleteDoc(myVoteRef);
      return { changed:true };
    }
    await setDoc(myVoteRef, { type, createdAt: snap.data()?.createdAt || now, updatedAt: now });
    return { changed:true };
  }

  /* === Sağ paneller === */
  async function fillSidebars(){
    const top3El=document.getElementById('top3');
    const latestEl=document.getElementById('latestList');
    top3El.innerHTML=''; latestEl.innerHTML='';

    if(!currentSentenceId) return;

    try{
      // Top 3 (parent.likes alanına göre — Cloud Function ile güncelleniyor)
      const qTop=query(
        collection(db,'completions'),
        where('sentenceId','==', currentSentenceId),
        orderBy('likes','desc'),
        limit(3)
      );
      const sTop=await getDocs(qTop);
      if(sTop.empty){
        top3El.innerHTML=`<div class="hint">Henüz gönderi yok</div>`;
      }else{
        sTop.forEach(d=>{
          const x=d.data();
          const initials=(x.nickname||'?').trim()[0]?.toUpperCase()||'?';
          const item=document.createElement('div');
          item.className='item';
          item.innerHTML=`
            <div class="avatar">${initials}</div>
            <div><strong>@${x.nickname||'Anonim'}</strong><div class="hint">👍 ${x.likes||0}</div></div>
          `;
          top3El.appendChild(item);
        });
      }

      // Son 10 (createdAt desc) + oy butonları
      const qLat=query(
        collection(db,'completions'),
        where('sentenceId','==', currentSentenceId),
        orderBy('createdAt','desc'),
        limit(10)
      );
      const sLat=await getDocs(qLat);
      if(sLat.empty){
        latestEl.innerHTML=`<div class="rowitem hint">Henüz gönderi yok</div>`;
      }else{
        for(const d of sLat.docs){
          const x=d.data();
          const cid=d.id;
          const text=(x.text||'').toString();
          const nick=x.nickname || 'Anonim';

          const row=document.createElement('div');
          row.className='rowitem';
          row.innerHTML=`
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
              <div class="hint"><strong>@${nick}</strong>: “${escapeHtml(text).slice(0,160)}”</div>
              <div class="row" style="gap:6px">
                <button class="btn btn-ghost" data-vote="like" data-id="${cid}">👍 <span class="lk">0</span></button>
                <button class="btn btn-ghost" data-vote="dislike" data-id="${cid}">👎 <span class="dk">0</span></button>
              </div>
            </div>
          `;
          latestEl.appendChild(row);

          try{
            const c=await getVoteCounts(cid);
            row.querySelector('.lk').textContent=c.likes;
            row.querySelector('.dk').textContent=c.dislikes;
          }catch(e){}
        }

        // tıklamaları tek sefer bağla
        latestEl.addEventListener('click', async (e)=>{
          const btn=e.target.closest('button[data-vote]');
          if(!btn) return;
          const type=btn.getAttribute('data-vote');
          const cid =btn.getAttribute('data-id');
          try{
            const res=await toggleVote(cid, type);
            if(res?.changed){
              const parent=btn.parentElement;
              const c=await getVoteCounts(cid);
              parent.querySelector('.lk').textContent=c.likes;
              parent.querySelector('.dk').textContent=c.dislikes;
              // Top 3 değişmiş olabilir; yeniden yükle (hafif maliyet)
              await fillTop3Only();
            }
          }catch(err){
            console.error('[Vote]', err);
            window.toast?.('Oy verilemedi: ' + (err.code||err.message));
          }
        }, { once:true });
      }
    }catch(e){
      console.error('[Sidebars]', e);
      top3El.innerHTML=`<div class="hint">Yüklenemedi</div>`;
      latestEl.innerHTML=`<div class="rowitem hint">Yüklenemedi</div>`;
    }
  }

  async function fillTop3Only(){
    const top3El=document.getElementById('top3');
    top3El.innerHTML='';
    try{
      const qTop=query(
        collection(db,'completions'),
        where('sentenceId','==', currentSentenceId),
        orderBy('likes','desc'),
        limit(3)
      );
      const sTop=await getDocs(qTop);
      if(sTop.empty){
        top3El.innerHTML=`<div class="hint">Henüz gönderi yok</div>`;
      }else{
        sTop.forEach(d=>{
          const x=d.data();
          const initials=(x.nickname||'?').trim()[0]?.toUpperCase()||'?';
          const item=document.createElement('div');
          item.className='item';
          item.innerHTML=`
            <div class="avatar">${initials}</div>
            <div><strong>@${x.nickname||'Anonim'}</strong><div class="hint">👍 ${x.likes||0}</div></div>
          `;
          top3El.appendChild(item);
        });
      }
    }catch(e){
      top3El.innerHTML=`<div class="hint">Yenilenemedi</div>`;
    }
  }

  // XSS koruması
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
