<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lafkat ‚Äì Admin Paneli</title>
<meta name="theme-color" content="#FF7F2F" />
<style>
  :root{--orange:#FF7F2F;--orange-2:#ff9a58;--ink:#1b1b1b;--line:#ffd7bf}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,var(--orange) 0%,var(--orange-2) 100%);color:var(--ink)}
  .header{background:#fff4ec;border-bottom:1px solid var(--line)}
  .header .inner{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
  nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  nav a{text-decoration:none;color:#7a3b14;font-weight:700;font-size:14px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff}
  nav a:hover{background:#ffefe4;border-color:#ffb98d}
  .wrap{max-width:1200px;margin:16px auto;padding:16px;display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
  h2{margin:0 0 8px;font-size:20px;color:#7a3b14}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .col{display:grid;gap:8px}
  input,textarea,select{padding:10px;border:1.5px solid #ffd0b3;border-radius:10px;font-size:14px}
  textarea{min-height:90px}
  .btn{cursor:pointer;border:none;background:#FF7F2F;color:#fff;padding:10px 14px;border-radius:10px;font-weight:800}
  .btn.secondary{background:#fff;color:#ff6a08;border:1.6px solid #ffd0b3}
  .muted{color:#8b5a3a;font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #ffe1ce;text-align:left;font-size:14px;vertical-align:top}
  th{background:#fff9f4;color:#7a3b14;font-weight:900}
  .pill{display:inline-block;background:#ffe8d7;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
  .warn{color:#a33}
  .ok{color:#0a7a3a}
  .hidden{display:none}
  .empty{border:1px dashed #ffc49f;border-radius:10px;padding:12px;background:#fff7ef;color:#7a3b14}
</style>
</head>
<body>
<header class="header">
  <div class="inner">
    <div style="width:40px;height:40px;border-radius:10px;background:radial-gradient(100% 100% at 30% 30%,#ffd18f,#ff7f2f);display:grid;place-items:center;color:#fff;font-weight:900">üõ†Ô∏è</div>
    <strong>Lafkat ‚Ä¢ Admin</strong>
    <nav>
      <a href="index-compact.html">Bug√ºn√ºn C√ºmlesi</a>
      <a href="forum.html">Forum</a>
      <a href="leaderboard.html">Liderlik</a>
      <a href="profile.html">Profil</a>
      <a href="settings.html">Ayarlar</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Admin kontrol -->
  <div id="adminGate" class="card">
    <div class="row">
      <span class="pill" id="modeTag">demo (offline)</span>
      <span id="adminStatus" class="warn">Admin yetkisi doƒürulanmadƒ±.</span>
    </div>
    <div class="muted">Bu sayfa yalnƒ±zca <b>roles.admin = true</b> kullanƒ±cƒ±lar i√ßindir.</div>
  </div>

  <!-- Bug√ºn√ºn c√ºmlesi -->
  <section class="card">
    <h2>Bug√ºn√ºn C√ºmlesi</h2>
    <div class="row">
      <div class="col" style="flex:1">
        <label>C√ºmle</label>
        <textarea id="promptText" placeholder="√ñrn: Bug√ºn i≈üe giderken ____ y√ºz√ºnden geciktim."></textarea>
      </div>
      <div class="col">
        <label>Tarih</label>
        <input id="promptDate" type="date" />
        <button class="btn" id="btnSavePrompt">Kaydet</button>
        <button class="btn secondary" id="btnLoadToday">Bug√ºn√º Y√ºkle</button>
        <div class="muted">Tarih bo≈üsa otomatik bug√ºn kaydedilir.</div>
      </div>
    </div>
    <div id="promptMsg" class="muted"></div>
  </section>

  <!-- √ñneriler (onay / red) -->
  <section class="card">
    <h2>C√ºmle √ñnerileri (Bekleyen)</h2>
    <div class="row">
      <button class="btn secondary" id="btnReloadSuggestions">Yenile</button>
      <span class="pill" id="sugCount">0 √∂neri</span>
    </div>
    <div class="muted">Durumlar: <span class="pill">pending</span>, <span class="pill">approved</span>, <span class="pill">rejected</span></div>
    <div id="sugWrap" class="empty">Bekleyen √∂neri yok.</div>
    <table id="sugTable" class="hidden">
      <thead>
        <tr>
          <th>√ñneri</th><th>Kimden</th><th>Tarih</th><th>ƒ∞≈ülem</th>
        </tr>
      </thead>
      <tbody id="sugBody"></tbody>
    </table>
  </section>

  <!-- Bug√ºn√ºn g√∂nderileri (moderasyon) -->
  <section class="card">
    <h2>Bug√ºn√ºn G√∂nderileri (Moderasyon)</h2>
    <div class="row">
      <button class="btn secondary" id="btnReloadPosts">Yenile</button>
      <span class="pill" id="postCount">0 g√∂nderi</span>
    </div>
    <div id="postsWrap" class="empty">Bug√ºn i√ßin g√∂nderi bulunamadƒ±.</div>
    <table id="postsTable" class="hidden">
      <thead>
        <tr>
          <th>Kullanƒ±cƒ±</th><th>Metin</th><th>Beƒüeni</th><th>Saat</th><th>ƒ∞≈ülem</th>
        </tr>
      </thead>
      <tbody id="postsBody"></tbody>
    </table>
  </section>
</main>

<footer style="max-width:1200px;margin:0 auto 20px;padding:0 16px;color:#fff;opacity:.9">
  ¬© Lafkat ‚Ä¢ Admin
</footer>

<!-- Firebase (opsiyonel) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
/* ===== Ayarlar ===== */
let ENABLE_FIREBASE=false; // üî¥ canlƒ±ya alƒ±rken true yap
const firebaseConfig={
  // apiKey:"...", authDomain:"...", projectId:"lafkat-23687"
};

const $=s=>document.querySelector(s);
const todayId=()=>{const t=new Date();const y=t.getFullYear(),m=String(t.getMonth()+1).padStart(2,'0'),d=String(t.getDate()).padStart(2,'0');return `${y}-${m}-${d}`;}
const toISO=(ts)=> ts?.toDate ? ts.toDate().toISOString() : (ts?.toISOString ? ts.toISOString() : new Date(ts||Date.now()).toISOString());

let db=null,auth=null,currentUser=null,isAdmin=false;

/* ===== Init ===== */
(function init(){
  if(firebaseConfig && firebaseConfig.projectId && ENABLE_FIREBASE){
    firebase.initializeApp(firebaseConfig); db=firebase.firestore(); auth=firebase.auth();
    $("#modeTag").textContent="canlƒ± (Firebase)";
    auth.onAuthStateChanged(async (u)=>{
      currentUser=u||null;
      isAdmin=false;
      if(u){
        const doc=await db.collection("users").doc(u.uid).get();
        isAdmin=!!doc.data()?.roles?.admin;
      }
      $("#adminStatus").textContent = isAdmin ? "Admin yetkisi doƒürulandƒ±." : "Admin yetkisi yok.";
      $("#adminStatus").className   = isAdmin ? "ok" : "warn";
      if(isAdmin){ await loadTodayPrompt(); await loadSuggestions(); await loadTodayPosts(); }
    });
  }else{
    $("#modeTag").textContent="demo (offline)";
    $("#adminStatus").textContent="(DEMO) Admin yetkisi varsayƒ±ldƒ±.";
    $("#adminStatus").className="ok";
    demoFill();
  }
})();

/* ===== Bug√ºn√ºn C√ºmlesi ===== */
async function loadTodayPrompt(){
  if(!db) return;
  const doc = await db.collection("dailyPrompts").doc(todayId()).get();
  $("#promptText").value = doc.exists ? (doc.data().promptText||"") : "";
  $("#promptDate").value = todayId();
}
$("#btnLoadToday").addEventListener("click", loadTodayPrompt);

$("#btnSavePrompt").addEventListener("click", async ()=>{
  const text = $("#promptText").value.trim();
  const date = ($("#promptDate").value || todayId());
  if(!text) return $("#promptMsg").textContent="C√ºmle bo≈ü olamaz.";
  if(!db){ $("#promptMsg").textContent="(DEMO) Kaydedildi."; return; }
  if(!isAdmin) return alert("Yetkisiz.");

  await db.collection("dailyPrompts").doc(date).set({
    promptText: text,
    setBy: currentUser?.uid || "admin",
    status: "active",
    date: firebase.firestore.Timestamp.now()
  }, { merge:true });
  $("#promptMsg").textContent="Kaydedildi.";
});

/* ===== √ñneriler ===== */
async function loadSuggestions(){
  if(!db){ renderSuggestions(DEMO_SUGS); return; }
  const snap = await db.collection("promptSuggestions").where("status","==","pending")
    .orderBy("at","desc").limit(50).get();
  const rows=snap.docs.map(d=>({id:d.id, ...d.data(), iso: toISO(d.data().at)}));
  renderSuggestions(rows);
}
function renderSuggestions(list){
  $("#sugCount").textContent = `${list.length} √∂neri`;
  const wrap=$("#sugWrap"), tbl=$("#sugTable"), body=$("#sugBody");
  if(list.length===0){ wrap.classList.remove("hidden"); tbl.classList.add("hidden"); return; }
  wrap.classList.add("hidden"); tbl.classList.remove("hidden"); body.innerHTML="";
  list.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(s.text||"")}</td>
      <td>${escapeHTML(s.name||"")}</td>
      <td><span class="muted">${(s.iso||"").slice(0,16).replace("T"," ")}</span></td>
      <td>
        <button class="btn secondary" onclick="approveSug('${s.id}')">Onayla</button>
        <button class="btn secondary" onclick="rejectSug('${s.id}')">Reddet</button>
        <button class="btn" onclick="useSugToday('${encodeURIComponent(s.text||"")}')">Bug√ºn√ºn C√ºmlesi Yap</button>
      </td>`;
    body.appendChild(tr);
  });
}
async function approveSug(id){
  if(!db){ alert("(DEMO) Onaylandƒ±."); return; }
  if(!isAdmin) return alert("Yetkisiz.");
  await db.collection("promptSuggestions").doc(id).set({ status:"approved" },{merge:true});
  await loadSuggestions();
}
async function rejectSug(id){
  if(!db){ alert("(DEMO) Reddedildi."); return; }
  if(!isAdmin) return alert("Yetkisiz.");
  await db.collection("promptSuggestions").doc(id).set({ status:"rejected" },{merge:true});
  await loadSuggestions();
}
function useSugToday(enc){
  const txt = decodeURIComponent(enc);
  $("#promptText").value = txt;
  $("#promptDate").value = todayId();
}

/* ===== G√∂nderiler (Bug√ºn) ===== */
async function loadTodayPosts(){
  if(!db){ renderPosts(DEMO_POSTS); return; }
  const snap = await db.collection("posts").where("promptDate","==", todayId()).orderBy("at","desc").get();
  const rows = snap.docs.map(d=>({id:d.id, ...d.data(), iso: toISO(d.data().at)}));
  renderPosts(rows);
}
function renderPosts(list){
  $("#postCount").textContent = `${list.length} g√∂nderi`;
  const wrap=$("#postsWrap"), tbl=$("#postsTable"), body=$("#postsBody");
  if(list.length===0){ wrap.classList.remove("hidden"); tbl.classList.add("hidden"); return; }
  wrap.classList.add("hidden"); tbl.classList.remove("hidden"); body.innerHTML="";
  list.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHTML(p.name||"Kullanƒ±cƒ±")}</td>
      <td>${escapeHTML(p.text||"")}</td>
      <td>${p.likes||0}</td>
      <td><span class="muted">${(p.iso||"").slice(11,16)}</span></td>
      <td><button class="btn" onclick="deletePost('${p.id}')">Sil</button></td>`;
    body.appendChild(tr);
  });
}
async function deletePost(id){
  if(!db){ alert("(DEMO) Silindi."); return; }
  if(!isAdmin) return alert("Yetkisiz.");
  if(!confirm("G√∂nderi silinsin mi?")) return;
  await db.collection("posts").doc(id).delete();
  await loadTodayPosts();
}

/* ===== Yardƒ±mcƒ±lar ===== */
function escapeHTML(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));}

/* ===== DEMO i√ßeriƒüi ===== */
const DEMO_SUGS=[
  {id:"s1", text:"Ak≈üam yemeƒüinde konu birden ____ d√∂n√ºverdi.", name:"Site Y√∂neticisi", iso:new Date().toISOString()},
  {id:"s2", text:"Tatile √ßƒ±kmadan √∂nce mutlaka ____ kontrol ederim.", name:"Mina R.", iso:new Date().toISOString()}
];
const DEMO_POSTS=[
  {id:"p1", name:"Mina R.", text:"Bug√ºn i≈üe giderken kediyi sevmek y√ºz√ºnden geciktim.", likes:7, iso:new Date().toISOString()},
  {id:"p2", name:"Zeynep A.", text:"Bug√ºn i≈üe giderken otob√ºs√º ≈üarkƒ± s√∂yleyerek ka√ßƒ±rdƒ±m.", likes:4, iso:new Date().toISOString()}
];
function demoFill(){
  $("#promptText").value="Bug√ºn i≈üe giderken ____ y√ºz√ºnden geciktim.";
  $("#promptDate").value=todayId();
  renderSuggestions(DEMO_SUGS);
  renderPosts(DEMO_POSTS);
}

/* ===== Buton baƒülarƒ± ===== */
$("#btnReloadSuggestions").addEventListener("click", loadSuggestions);
$("#btnReloadPosts").addEventListener("click", loadTodayPosts);
</script>
</body>
</html>
