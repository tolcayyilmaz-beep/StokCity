<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wallyus – Admin</title>
  <meta name="description" content="Wallyus kampanya admin paneli" />
  <style>
    :root{
      --bg1:#b9f3ff; --bg2:#e8fbff;
      --primary:#0b63b6; --accent:#10b0ff;
      --text:#0e2a3b; --muted:#5b6970; --white:#fff;
      --border:rgba(11,99,182,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:linear-gradient(160deg,var(--bg2),var(--bg1));
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
    }
    header{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 16px; background:var(--white); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:8px;font-weight:700}
    .wlogo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;
      background:linear-gradient(145deg,#0d7dd8,#0b63b6); color:#fff;}
    .pill{background:#eef6ff;padding:4px 10px;border-radius:999px;font-size:12px}
    .btn{padding:6px 12px;border-radius:8px;border:1px solid var(--border);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(145deg, var(--accent), var(--primary)); color:#fff; border:none}
    .btn.danger{background:#fee2e2;color:#7a271a;border-color:#fecaca}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    main{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:var(--white);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .login{max-width:420px;margin:40px auto;padding:20px}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:18px;margin:0 0 10px}
    label{font-size:13px;font-weight:600}
    input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px}
    .alert{margin-top:10px;padding:10px;border-radius:8px;font-size:14px;display:none}
    .alert.show{display:block}
    .alert.error{background:#fef3f2;border:1px solid #fecdca;color:#7a271a}
    .hidden{display:none!important}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;font-size:14px;text-align:left}
    th{background:#f9fbff;position:sticky;top:0}
    footer{text-align:center;color:var(--muted);font-size:12px;padding:16px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="wlogo">W</div> Wallyus Admin
      <span id="counterPill" class="pill">Kontenjan: yükleniyor…</span>
    </div>
    <div>
      <button id="btnExport" class="btn">CSV Dışa Aktar</button>
      <button id="btnLogout" class="btn danger hidden">Çıkış</button>
    </div>
  </header>

  <main>
    <!-- LOGIN -->
    <section id="loginCard" class="card login">
      <h1>Giriş Yap</h1>
      <p style="font-size:13px;color:gray">Yalnızca yetkili admin e-postaları giriş yapabilir.</p>
      <div>
        <label for="email">E-posta</label>
        <input id="email" type="email" placeholder="admin@wallyus.com">
      </div>
      <div>
        <label for="password">Şifre</label>
        <input id="password" type="password" placeholder="••••••••">
      </div>
      <button id="btnLogin" class="btn primary" style="margin-top:10px;width:100%">Giriş Yap</button>
      <div id="loginError" class="alert error"></div>
    </section>

    <!-- DATA -->
    <section id="dataCard" class="card hidden" style="padding:16px">
      <h2>Kayıtlar</h2>
      <div class="filters">
        <input id="q" placeholder="Arama (ad/soyad/e-posta)">
        <input id="from" type="date">
        <input id="to" type="date">
        <button id="btnRefresh" class="btn">Listeyi Getir</button>
      </div>
      <div style="overflow:auto;max-height:400px">
        <table id="tbl">
          <thead>
            <tr><th>Tarih</th><th>Ad</th><th>Soyad</th><th>E-posta</th><th>Onay</th><th>Kaynak</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="rowsInfo" style="font-size:13px;color:gray;margin-top:6px">0 kayıt</p>
    </section>
  </main>

  <footer>© <span id="year"></span> Wallyus</footer>

  <!-- Firebase -->
  <script type="module">
    const firebaseConfig = {
  apiKey: "AIzaSyCZr30DxXL-MPl8fbg5---WMKLAME_9ReE",
  authDomain: "wallyus-advert.firebaseapp.com",
  projectId: "wallyus-advert",
  storageBucket: "wallyus-advert.appspot.com",
  messagingSenderId: "886558875581",
  appId: "1:886558875581:web:1843f409531ab92c3d3cd4"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const el=(id)=>document.getElementById(id);
    const loginCard=el("loginCard"),dataCard=el("dataCard");
    const btnLogin=el("btnLogin"),btnLogout=el("btnLogout");
    const btnRefresh=el("btnRefresh"),btnExport=el("btnExport");
    const tblBody=document.querySelector("#tbl tbody");
    el("year").textContent=new Date().getFullYear();

    function showLogin(show){
      loginCard.classList.toggle("hidden",!show);
      dataCard.classList.toggle("hidden",show);
      btnLogout.classList.toggle("hidden",show);
    }

    // Login
    btnLogin.addEventListener("click",async()=>{
      const email=el("email").value.trim();
      const password=el("password").value.trim();
      if(!email||!password){el("loginError").textContent="E-posta ve şifre zorunludur.";el("loginError").classList.add("show");return;}
      try{await signInWithEmailAndPassword(auth,email,password);}catch(e){el("loginError").textContent="Giriş başarısız: "+e.message;el("loginError").classList.add("show");}
    });
    btnLogout.addEventListener("click",()=>signOut(auth));

    onAuthStateChanged(auth,(user)=>{ if(user){ showLogin(false); refreshAll(); } else{ showLogin(true); } });

    async function loadCounter(){
      const snap=await getDoc(doc(db,"counters","test_group"));
      if(snap.exists()){const c=snap.data().count||0; el("counterPill").textContent=`Kontenjan: ${c}/100`; }
    }

    async function loadRows(){
      const qText=el("q").value.trim().toLowerCase();
      const from=el("from").value?new Date(el("from").value):null;
      const to=el("to").value?new Date(el("to").value+"T23:59:59"):null;
      const snap=await getDocs(query(collection(db,"campaign_signups"),orderBy("createdAt","desc"),limit(1000)));
      const rows=[];
      snap.forEach(d=>{
        const x=d.data(); const t=x.createdAt?.toDate?.()||null;
        if(from&&t<from)return; if(to&&t>to)return;
        const hay=[x.firstName||"",x.lastName||"",x.email||""].join(" ").toLowerCase();
        if(qText&&!hay.includes(qText))return;
        rows.push({createdAt:t,...x});
      });
      tblBody.innerHTML="";
      for(const r of rows){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.createdAt?r.createdAt.toLocaleString():""}</td>
                      <td>${r.firstName||""}</td><td>${r.lastName||""}</td>
                      <td>${r.email||""}</td><td>${r.consent?"✓":"—"}</td>
                      <td>${r.source||""}</td>`;
        tblBody.appendChild(tr);
      }
      el("rowsInfo").textContent=`${rows.length} kayıt listelendi`;
      window.__rows=rows;
    }

    async function refreshAll(){ await Promise.all([loadCounter(),loadRows()]); }
    btnRefresh.addEventListener("click",refreshAll);

    // CSV export
    btnExport.addEventListener("click",()=>{
      const rows=window.__rows||[];
      const header=["createdAt","firstName","lastName","email","consent","source"];
      const csv=[header.join(",")].concat(rows.map(r=>[
        r.createdAt?r.createdAt.toISOString():"",
        `"${(r.firstName||"").replace(/"/g,'""')}"`,
        `"${(r.lastName||"").replace(/"/g,'""')}"`,
        `"${(r.email||"").replace(/"/g,'""')}"`,
        r.consent?"true":"false",
        `"${(r.source||"").replace(/"/g,'""')}"`
      ].join(","))).join("\n");
      const blob=new Blob([new Uint8Array([0xEF,0xBB,0xBF]),csv],{type:"text/csv;charset=utf-8"});
      const url=URL.createObjectURL(blob); const a=document.createElement("a");
      a.href=url;a.download="wallyus_signups.csv";a.click();setTimeout(()=>URL.revokeObjectURL(url),0);
    });
  </script>
</body>
</html>
