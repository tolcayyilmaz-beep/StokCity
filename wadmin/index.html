<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wallyus – Admin</title>
  <meta name="description" content="Wallyus kampanya admin paneli" />
  <style>
    :root{
      --bg1:#b9f3ff; --bg2:#e8fbff;
      --primary:#0b63b6; --accent:#10b0ff;
      --text:#0e2a3b; --muted:#5b6970; --white:#fff;
      --border:rgba(11,99,182,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:linear-gradient(160deg,var(--bg2),var(--bg1));
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
    }
    header{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 16px; background:var(--white); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:8px;font-weight:700}
    .wlogo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;
      background:linear-gradient(145deg,#0d7dd8,#0b63b6); color:#fff;}
    .pill{background:#eef6ff;padding:4px 10px;border-radius:999px;font-size:12px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(145deg, var(--accent), var(--primary)); color:#fff; border:none}
    .btn.danger{background:#fee2e2;color:#7a271a;border-color:#fecaca}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    main{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:var(--white);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .login{max-width:440px;margin:40px auto;padding:20px}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:18px;margin:0 0 12px}
    label{font-size:13px;font-weight:600}
    input{width:100%;padding:11px;border:1px solid var(--border);border-radius:10px}
    .row{display:grid;gap:10px}
    .check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);margin-top:6px}
    .alert{margin-top:10px;padding:10px;border-radius:10px;font-size:14px;display:none}
    .alert.show{display:block}
    .alert.error{background:#fef3f2;border:1px solid #fecdca;color:#7a271a}
    .hidden{display:none!important}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eef2f7;padding:10px 8px;font-size:14px;text-align:left;white-space:nowrap}
    th{background:#f9fbff;position:sticky;top:0}
    footer{text-align:center;color:var(--muted);font-size:12px;padding:16px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="wlogo">W</div> Wallyus Admin
      <span id="counterPill" class="pill">Kontenjan: yükleniyor…</span>
    </div>
    <div>
      <button id="btnExport" class="btn">CSV Dışa Aktar</button>
      <button id="btnLogout" class="btn danger hidden">Çıkış</button>
    </div>
  </header>

  <main>
    <!-- LOGIN -->
    <section id="loginCard" class="card login">
      <h1>Giriş Yap</h1>
      <p style="font-size:13px;color:gray;margin-top:0">Yalnızca yetkili admin e-postaları giriş yapabilir.</p>
      <div class="row">
        <div>
          <label for="email">E-posta</label>
          <input id="email" type="email" placeholder="admin@wallyus.com">
        </div>
        <div>
          <label for="password">Şifre</label>
          <input id="password" type="password" placeholder="••••••••">
        </div>
        <label class="check">
          <input id="remember" type="checkbox"> Beni hatırla (bu cihazda oturumu açık tut)
        </label>
        <button id="btnLogin" class="btn primary" style="margin-top:6px">Giriş Yap</button>
        <div id="loginError" class="alert error"></div>
      </div>
    </section>

    <!-- DATA -->
    <section id="dataCard" class="card hidden" style="padding:16px">
      <h2>Kayıtlar</h2>
      <div class="filters">
        <input id="q" placeholder="Arama (ad / soyad / e-posta)">
        <button id="btnRefresh" class="btn">Listeyi Getir</button>
      </div>
      <div style="overflow:auto;max-height:440px">
        <table id="tbl">
          <thead>
            <tr><th>Tarih</th><th>Ad</th><th>Soyad</th><th>E-posta</th><th>Onay</th><th>Kaynak</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="rowsInfo" style="font-size:13px;color:gray;margin-top:6px">0 kayıt</p>
    </section>
  </main>

  <footer>© <span id="year"></span> Wallyus</footer>

  <!-- Firebase -->
  <script type="module">
    // 🔧 Kendi Firebase config'inizi ekleyin
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const el=(id)=>document.getElementById(id);
    const loginCard=el("loginCard"), dataCard=el("dataCard");
    const btnLogin=el("btnLogin"), btnLogout=el("btnLogout");
    const btnRefresh=el("btnRefresh"), btnExport=el("btnExport");
    const qInput=el("q"); const tblBody=document.querySelector("#tbl tbody");
    el("year").textContent=new Date().getFullYear();

    function showLogin(show){
      loginCard.classList.toggle("hidden",!show);
      dataCard.classList.toggle("hidden",show);
      btnLogout.classList.toggle("hidden",show);
    }

    // 🔐 Login + "Beni hatırla" (kalıcı oturum)
    btnLogin.addEventListener("click", async ()=>{
      const email = el("email").value.trim();
      const password = el("password").value.trim();
      const remember = el("remember").checked;
      const loginError = el("loginError");
      loginError.classList.remove("show");

      if(!email || !password){
        loginError.textContent = "E-posta ve şifre zorunludur.";
        loginError.classList.add("show");
        return;
      }

      try{
        await setPersistence(auth, remember ? browserLocalPersistence : browserSessionPersistence);
        await signInWithEmailAndPassword(auth, email, password);
      }catch(err){
        loginError.textContent = "Giriş başarısız: " + (err?.message || "Hata");
        loginError.classList.add("show");
      }
    });

    btnLogout.addEventListener("click", ()=> signOut(auth));

    onAuthStateChanged(auth, (user)=>{
      if(user){ showLogin(false); refreshAll(); }
      else    { showLogin(true); }
    });

    // 📊 Sayaç oku
    async function loadCounter(){
      const snap = await getDoc(doc(db, "counters", "test_group"));
      if(snap.exists()){
        const c = snap.data().count || 0;
        el("counterPill").textContent = `Kontenjan: ${c}/100`;
      }else{
        el("counterPill").textContent = "Kontenjan: tanımsız";
      }
    }

    // 📥 Kayıtları getir (son 1000)
    async function loadRows(){
      const qText = qInput.value.trim().toLowerCase();
      const snap = await getDocs(query(collection(db, "campaign_signups"), orderBy("createdAt", "desc"), limit(1000)));
      const rows = [];
      snap.forEach(d=>{
        const x = d.data();
        const t = x.createdAt?.toDate?.() || null;
        const hay = [(x.firstName||""),(x.lastName||""),(x.email||"")].join(" ").toLowerCase();
        if(qText && !hay.includes(qText)) return;
        rows.push({ createdAt:t, ...x });
      });

      // tabloya bas
      tblBody.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.createdAt ? r.createdAt.toLocaleString() : ""}</td>
          <td>${esc(r.firstName||"")}</td>
          <td>${esc(r.lastName||"")}</td>
          <td>${esc(r.email||"")}</td>
          <td>${r.consent ? "✓" : "—"}</td>
          <td>${esc(r.source||"")}</td>`;
        tblBody.appendChild(tr);
      }
      el("rowsInfo").textContent = `${rows.length} kayıt listelendi`;
      window.__rows = rows; // export için
    }

    async function refreshAll(){ await Promise.all([loadCounter(), loadRows()]); }
    btnRefresh.addEventListener("click", refreshAll);

    // 📤 CSV Export
    btnExport.addEventListener("click", ()=>{
      const rows = window.__rows || [];
      const header = ["createdAt","firstName","lastName","email","consent","source"];
      const csv = [header.join(",")].concat(
        rows.map(r=>[
          r.createdAt ? isoLocal(r.createdAt) : "",
          csvSafe(r.firstName), csvSafe(r.lastName), csvSafe(r.email),
          r.consent ? "true" : "false",
          csvSafe(r.source)
        ].join(","))
      ).join("\n");

      const blob = new Blob([new Uint8Array([0xEF,0xBB,0xBF]), csv], {type:"text/csv;charset=utf-8"}); // UTF-8 BOM
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "wallyus_campaign_signups.csv"; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 0);
    });

    // Utils
    function isoLocal(d){
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function csvSafe(s){ const t=(s||"").replace(/"/g,'""'); return `"${t}"`; }
    function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
  </script>
</body>
</html>
